Sour Cyan Rabbit

High

# If Auction Fails, Some Bond Holders Each Period Will Never Be Able To Receive Coupon Payments Owed To Them

### Summary

**Severity:** 

Impact: High
Likelihood: Medium / High

**Description:** 


The protocol has paramaters that need to succeed in order for the Auction to succeed - and if they aren't met, the auction is labeled as Failed. The coupon payment distribution and coupon claiming logic depends completely on the `couponToken` `USDC` generated by the Auction for funding and distributing the coupon payments for each `distributionPeriod`. However, if the Auction fails, the `Distributor.sol` contract will never have enough balance of `USDC` `couponToken` to pay all of the owed coupon payments. 




### Root Cause

Each auction is started and a new auction contract is deployed after each distribution period has passed. Each auction is given the total amount of coupon tokens to distribute for that specific distribution period. That newly created auction is SOLELY responsible for generating enough USDC to fund the coupon payments owed to bond holders. 

However, if the auction fails, NO coupon tokens will be generated / distributed to the `Distributor` contract for that period. On top of this, another auction can never be started again for that specific period, the next auction can only begin after the NEXT distribution period. 

Regardless of the Auction failing, the bond token holders still have accounting for coupon tokens owed for that specific period and upon the success of the next Auction they will `claim` all of their owed coupons for both periods - but the `Distributor` contract will only have the balance of the coupon tokens generated from the second auction for the second bond duration period - causing the `Distributor` contract to not have enough balance to pay all of the bond holders their owed coupon payments for both periods. 

Below is the exact scenario: 

### Internal Pre-conditions

**Starting State:**
currentPeriod = 1 
couponAmountToDistribute = 10,000

1. The distribution period ends and the pool starts the auction `Pool::startAuction` 
- `currentPeriod` is incremented by 1, it now = 2
- lastDistributionTime` is updated to `block.timeStamp 

https://github.com/sherlock-audit/2024-12-plaza-finance/blob/main/plaza-evm/src/Pool.sol#L566-L570

2. The Auction Fails! The state of the auction is updated to the Failed state. This means that 0 reserveTokens are transferred out of the pool BUT ALSO that 0 `couponTokens` `usdc` are transferred TO THE POOL -> DISTRIBUTOR contract. 0 coupon tokens were essentially generated. 

https://github.com/sherlock-audit/2024-12-plaza-finance/blob/main/plaza-evm/src/Auction.sol#L336-L347

3. After the auction ends, the `distribute` function in `Pool.sol` is called - but it fails, it does not pass the require checks. The result is that the distributor contract is never sent any coupon Tokens and the `allocate` function is never called, allocating 0 couponTokens to be claimed by bond holders.

https://github.com/sherlock-audit/2024-12-plaza-finance/blob/main/plaza-evm/src/Pool.sol#L597-L602

**Current State At This Point:**
currentPeriod = 2 
lastDistributionTIme = (10 days ago, when the auction started) 
`Distribute.sol` contract balance of CouponToken = 0
Distribute.sol` variable `couponAmountToDistribute` = 0  -> this is the stored global variable that represents the amount of allocated coupons to distribute - it cannot distribute more than this variable.

`startAuction` cannot be started again for the period that it failed because of the updated `lastDistributionTIme` -> another auction can only be started after the next distribution period passes.

4. next Distribution Period passes, new action starts `Pool::startAuction` 

- this auction is started for `currentPeriod` = 2
- `couponAmountToDistribute` = 15,000  -> lets say more users bought bonds and the total supply of bonds increase during this new period, which makes the coupon token amount the protocol needs to pay higher.
- Auction increments the current period -> `currentPeriod` = 3 now

5. Auction Succeeds !!! 
- 15,000 coupon Tokens are transferred to `Distributor.sol` 
- 15,000 coupon tokens are allocated to be distributed within `Distributor` -> `couponAmountToDistribute` = 15,000

6. Users call `Distributor::claim` and claim their owed coupon payments for BOTH periods. 

https://github.com/sherlock-audit/2024-12-plaza-finance/blob/main/plaza-evm/src/Distributor.sol#L78-L89

- The `BondToken` contract is called to get the total amount of shares / coupon tokens the user is owed and will add the value of both periods.


### Impact

The first users that call `claim` and receive their coupon payments for BOTH periods will successfully receive their coupon payments. 

BUT the `Distributor` contract only has 15,000 coupon token balance and allocated to distribute, the bond holders are receiving their payments based off the total coupon payments for both periods they held, which the total coupon tokens needed to fulfill that is the amount for both periods (10,000 + 15,000) -> the `Distributor` only has 15,000.

The `Distributor` contract will run out of funds before every bond holder can `claim` their coupon payment. It will also run out of allocated coupon amount.

https://github.com/sherlock-audit/2024-12-plaza-finance/blob/main/plaza-evm/src/Distributor.sol#L91-L105

For every failed Auction, the distributor contract will always be under funded and be down the amount of coupon tokens needed for that period. This will always leave some users unable to `claim` their coupon tokens. For each failed auction, this gets worse. 


### Mitigation

There needs to be a way to generate the coupon Tokens needed for a distribution period when an auction fails, or the ability to re-run an a failed auction for the specific period. The issue is that the `Distributor` contract will be under-funded and based on the architecture, it relies on the auction for its funding. A single failed auction shouldnt leave it under-funded for the future. 